name: Security Audit

on:
  # Run weekly on Monday at 9:00 UTC (similar to Dependabot)
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Also run on PRs that modify dependencies
  pull_request:
    paths:
      - 'astronomer_starship/package.json'
      - 'astronomer_starship/package-lock.json'
      - 'pyproject.toml'
      - 'constraints.txt'

permissions:
  contents: read
  issues: write  # To create issues for vulnerabilities

jobs:
  audit-frontend:
    name: Frontend Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: astronomer_starship/package-lock.json

      - name: Install dependencies
        working-directory: astronomer_starship
        run: npm ci

      - name: Run npm audit
        id: audit
        working-directory: astronomer_starship
        shell: bash
        run: |
          set -o pipefail
          # npm audit exits non-zero when vulnerabilities are found.
          # Use --audit-level=high to ignore moderate (dev-only) vulnerabilities
          if npm audit --audit-level=high; then
            result="success"
          else
            result="failure"
          fi
          echo "result=${result}" >> "$GITHUB_OUTPUT"
          # Fail the job on non-scheduled runs (e.g. PRs) so we don't miss regressions.
          if [[ "${GITHUB_EVENT_NAME}" != "schedule" && "${result}" == "failure" ]]; then
            exit 1
          fi

      - name: Create issue for vulnerabilities
        if: steps.audit.outputs.result == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Security] Frontend vulnerabilities detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `Automated security audit detected vulnerabilities in frontend dependencies.

            **Action Required:**
            1. Review vulnerabilities: \`cd astronomer_starship && npm audit\`
            2. Fix automatically: \`npm audit fix\`
            3. Or update manually and test

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies,frontend'
            });

            const existingIssue = issues.data.find(issue => issue.title.includes('[Security] Frontend vulnerabilities'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'frontend']
              });
            }

  audit-backend:
    name: Backend Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          pip install --upgrade pip
          pip install -c constraints.txt '.[dev]'

      - name: Run pip-audit
        id: audit
        shell: bash
        run: |
          set -o pipefail
          # Note: pip-audit checks installed packages. This repo has no runtime deps,
          # so this primarily audits dev/test tooling installed via `.[dev]`.

          # Build ignore flags from ignore file (skip comments and empty lines)
          IGNORE_FLAGS=""
          if [[ -f .audit-ignore/pip-audit-ignore.txt ]]; then
            while IFS= read -r line; do
              # Skip comments and empty lines
              [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
              IGNORE_FLAGS="$IGNORE_FLAGS --ignore-vuln $line"
            done < .audit-ignore/pip-audit-ignore.txt
          fi

          if pip-audit --desc $IGNORE_FLAGS; then
            result="success"
          else
            result="failure"
          fi
          echo "result=${result}" >> "$GITHUB_OUTPUT"
          # Fail the job on non-scheduled runs (e.g. PRs) so we don't miss regressions.
          if [[ "${GITHUB_EVENT_NAME}" != "schedule" && "${result}" == "failure" ]]; then
            exit 1
          fi

      - name: Create issue for vulnerabilities
        if: steps.audit.outputs.result == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Security] Backend vulnerabilities detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `Automated security audit detected vulnerabilities in Python dependencies.

            **Action Required:**
            1. Review vulnerabilities: \`pip-audit\`
            2. Update vulnerable packages in \`pyproject.toml\`
            3. Test and verify fixes

            **Note:** This project has no runtime Python dependencies, so vulnerabilities are likely in dev dependencies.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies,backend'
            });

            const existingIssue = issues.data.find(issue => issue.title.includes('[Security] Backend vulnerabilities'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'backend']
              });
            }

  summary:
    name: Audit Summary
    runs-on: ubuntu-latest
    needs: [audit-frontend, audit-backend]
    if: always()
    steps:
      - name: Audit summary
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend audit: ${{ needs.audit-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend audit: ${{ needs.audit-backend.result }}" >> $GITHUB_STEP_SUMMARY
